{
  "metadata": {
    "system_name": "ExpenseLedger",
    "domain": "personal_finance",
    "source_story_type": "expense_tracker_story",
    "version": "1.0.0"
  },

  "system_overview": {
    "purpose": "Persist and manage a single-file JSON expense ledger with deterministic, auditable, and atomic persistence semantics.",
    "primary_goals": [
      "Persist all domain data in a single, human-readable JSON file whose path is configurable.",
      "Maintain deterministic, stable, pretty-printed JSON with stable field ordering.",
      "Encapsulate filesystem operations in a repository that performs atomic writes to prevent corruption.",
      "On startup, create or repair the store to a safe default if missing or invalid.",
      "Provide read-modify-write repository operations so business logic never accesses the filesystem directly."
    ],
    "non_goals": [
      "Remote or distributed storage.",
      "Concurrent multi-process writers.",
      "Rendering or UI responsibilities in the core modules."
    ],
    "wiring_strategy": {
      "description": "Explicit Manual Dependency Injection. AppController is the composition root and is responsible for constructing and wiring all components in the order listed.",
      "pattern": "manual_dependency_injection",
      "composition_root": "AppController",
      "instantiation_order": [
        "Config",
        "JsonSerializer",
        "AtomicFileWriter",
        "ExpenseRepository",
        "ExpenseValidator",
        "ExpenseService",
        "AppController"
      ]
    }
  },

  "runtime": {
    "entrypoint": {
      "module": "app_controller",
      "class": "AppController",
      "init_params": {
        "config": {
          "store_path": "data/expenses.json",
          "temp_suffix": ".tmp",
          "allowed_categories": ["food", "transport", "utilities", "entertainment", "health", "other"],
          "default_currency": "PLN",
          "description_max_length": 1024,
          "json_indent": 2,
          "serializer_field_order": {
            "store": ["expenses", "settings"],
            "expense": ["id", "date", "amount", "category", "description"],
            "settings": ["currency"]
          }
        }
      },
      "run_method": "start",
      "run_args": {}
    }
  },

  "modules": [
    {
      "name": "Config",
      "layer": "foundation",
      "responsibilities": ["Provide runtime tunables and defaults used across the system."],
      "components": [
        {
          "name": "Config",
          "type": "dataclass",
          "module": "config",
          "file": "src/config.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "store_path", "type": "string", "source": "value" },
              { "name": "temp_suffix", "type": "string", "source": "value" },
              { "name": "allowed_categories", "type": "list<string>", "source": "value" },
              { "name": "default_currency", "type": "string", "source": "value" },
              { "name": "description_max_length", "type": "int", "source": "value" },
              { "name": "json_indent", "type": "int", "source": "value" },
              { "name": "serializer_field_order", "type": "SerializerFieldOrder", "source": "value" }
            ]
          }
        }
      ]
    },

    {
      "name": "Models",
      "layer": "domain",
      "responsibilities": ["Define domain datatypes: Expense, Settings, ExpenseStore, and ServiceState enum."],
      "components": [
        {
          "name": "Expense",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": { "type": "composition", "args": [] }
        },
        {
          "name": "Settings",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": { "type": "composition", "args": [] }
        },
        {
          "name": "ExpenseStore",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": { "type": "composition", "args": [] }
        },
        {
          "name": "ServiceState",
          "type": "enum",
          "module": "models",
          "file": "src/models.py",
          "construction": { "type": "composition", "args": [] }
        }
      ]
    },

    {
      "name": "Serializer",
      "layer": "infrastructure",
      "responsibilities": ["Deterministic serialization/deserialization with stable field ordering and pretty-printing."],
      "components": [
        {
          "name": "JsonSerializer",
          "type": "class",
          "module": "json_serializer",
          "file": "src/json_serializer.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "field_order", "type": "SerializerFieldOrder", "source": "instance" },
              { "name": "indent", "type": "int", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "AtomicFileWriter",
      "layer": "infrastructure",
      "responsibilities": ["Provide atomic write primitive: write-to-temp, fsync, rename."],
      "components": [
        {
          "name": "AtomicFileWriter",
          "type": "class",
          "module": "atomic_file_writer",
          "file": "src/atomic_file_writer.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "fsync_after_write", "type": "bool", "source": "value" },
              { "name": "temp_suffix", "type": "string", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Repository",
      "layer": "infrastructure",
      "responsibilities": ["Load/validate/repair default store and perform atomic save of the full ExpenseStore."],
      "components": [
        {
          "name": "ExpenseRepository",
          "type": "class",
          "module": "expense_repository",
          "file": "src/expense_repository.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "config", "type": "Config", "source": "instance" },
              { "name": "serializer", "type": "JsonSerializer", "source": "instance" },
              { "name": "writer", "type": "AtomicFileWriter", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Validation",
      "layer": "domain",
      "responsibilities": ["Validate expense inputs and settings against domain invariants."],
      "components": [
        {
          "name": "ExpenseValidator",
          "type": "class",
          "module": "expense_validator",
          "file": "src/expense_validator.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "allowed_categories", "type": "list<string>", "source": "instance" },
              { "name": "description_max_length", "type": "int", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Service",
      "layer": "domain",
      "responsibilities": ["Business operations: add/update/delete/list expenses; delegate persistence to repository."],
      "components": [
        {
          "name": "ExpenseService",
          "type": "class",
          "module": "expense_service",
          "file": "src/expense_service.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "repository", "type": "ExpenseRepository", "source": "instance" },
              { "name": "validator", "type": "ExpenseValidator", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Controller",
      "layer": "infrastructure",
      "responsibilities": ["Startup orchestration, state machine ownership, expose service to adapters."],
      "components": [
        {
          "name": "AppController",
          "type": "class",
          "module": "app_controller",
          "file": "src/app_controller.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "config", "type": "Config", "source": "instance" },
              { "name": "serializer", "type": "JsonSerializer", "source": "instance" },
              { "name": "writer", "type": "AtomicFileWriter", "source": "instance" },
              { "name": "repository", "type": "ExpenseRepository", "source": "instance" },
              { "name": "service", "type": "ExpenseService", "source": "instance" }
            ]
          }
        }
      ]
    }
  ],

  "data_structures": [
    {
      "name": "Expense",
      "kind": "dataclass",
      "python_type_hint": "models.Expense",
      "fields": [
        { "name": "id", "type": "int" },
        { "name": "date", "type": "string" },
        { "name": "amount", "type": "decimal" },
        { "name": "category", "type": "string" },
        { "name": "description", "type": "string|null" }
      ]
    },
    {
      "name": "Settings",
      "kind": "dataclass",
      "python_type_hint": "models.Settings",
      "fields": [
        { "name": "currency", "type": "string" }
      ]
    },
    {
      "name": "ExpenseStore",
      "kind": "dataclass",
      "python_type_hint": "models.ExpenseStore",
      "fields": [
        { "name": "expenses", "type": "list<Expense>" },
        { "name": "settings", "type": "Settings" }
      ],
      "serialization_field_order": ["expenses", "settings"]
    },
    {
      "name": "ServiceState",
      "kind": "enum",
      "python_type_hint": "models.ServiceState",
      "values": ["INIT", "READY", "ERROR", "SHUTDOWN"]
    }
  ],

  "config": {
    "object_name": "Config",
    "fields": [
      { "name": "store_path", "type": "string", "default": "data/expenses.json" },
      { "name": "temp_suffix", "type": "string", "default": ".tmp" },
      { "name": "allowed_categories", "type": "list<string>", "default": ["food", "transport", "utilities", "entertainment", "health", "other"] },
      { "name": "default_currency", "type": "string", "default": "PLN" },
      { "name": "description_max_length", "type": "int", "default": 1024 },
      { "name": "json_indent", "type": "int", "default": 2 },
      {
        "name": "serializer_field_order",
        "type": "SerializerFieldOrder",
        "default": {
          "store": ["expenses", "settings"],
          "expense": ["id", "date", "amount", "category", "description"],
          "settings": ["currency"]
        }
      }
    ]
  },

  "build_instructions": {
    "language": "python",
    "source_layout": "src/",
    "main_module": "src/app_controller.py",
    "recommended_packages": ["pytest"],
    "notes": "Implement AppController.start() to perform the wiring sequence: construct Config -> JsonSerializer -> AtomicFileWriter -> ExpenseRepository -> ExpenseValidator -> ExpenseService -> AppController. Expose AppController.start() as the runtime entrypoint."
  }
}
