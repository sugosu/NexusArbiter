{
  "metadata": {
    "system_name": "ExampleServicePlatform",
    "domain": "Generic Distributed Application",
    "source_story_type": "implementation_story_v2_architect_enhanced",
    "version": "1.1.0"
  },
  "system_overview": {
    "purpose": "Provide a generic, modular service platform with clear separation between API layer, business logic, background processing, and persistence.",
    "primary_goals": [
      "Deterministic, well-defined behavior for core flows given a configuration.",
      "Loosely coupled modules that can be implemented and tested independently.",
      "A structure that downstream tools can use to generate code, tests, and wiring without guessing."
    ],
    "non_goals": [
      "Defining domain-specific business rules.",
      "Implementing a particular UI framework or frontend.",
      "Handling multi-tenant, multi-region deployment concerns."
    ],
    "wiring_strategy": {
      "description": "Explicit Manual Dependency Injection. The 'main' entrypoint is responsible for constructing the object graph in the specific order defined below.",
      "pattern": "manual_dependency_injection",
      "composition_root": "main.py -> ServiceHost",
      "instantiation_order": [
        "ServiceConfig",
        "Logger",
        "MetricsCollector",
        "Repositories (DataStoreAdapter)",
        "ApplicationServices",
        "HttpApiHost",
        "WorkerHost",
        "ServiceHost"
      ]
    }
  },
  "environment": {
    "runtime_model": "single_process_or_multi_process",
    "execution_model": "request_response_plus_background_jobs",
    "entrypoint": "main.py orchestrates construction; ServiceHost.start() initiates runtime.",
    "persistence": {
      "strategy": "pluggable_data_store",
      "scope": "domain_entities_and_operational_metadata"
    },
    "ui_mode": "external_client_or_frontend",
    "headless_support": true
  },

  "runtime": {
    "entrypoint": {
      "module": "service_host",
      "class": "ServiceHost",
      "init_params": {
        "config": {
          "service_name": "example-service",
          "environment": "dev",
          "http_port": 8080,
          "worker_concurrency": 4
        }
      },
      "run_method": "start",
      "run_args": {}
    }
  },

  "actors": [
    {
      "name": "ClientApplication",
      "type": "external_system",
      "description": "Any external client (web, mobile, service) that invokes APIs or publishes messages.",
      "interaction_direction": "ClientApplication -> HttpApiHost -> ApplicationServices"
    },
    {
      "name": "Operator",
      "type": "human",
      "description": "Configures the platform, monitors logs and metrics, and triggers maintenance operations.",
      "interaction_direction": "Operator -> AdminInterface_or_CLI -> System"
    },
    {
      "name": "ExternalDataSource",
      "type": "external_system",
      "description": "Third-party or upstream system integrated via connectors or adapters.",
      "interaction_direction": "System <-> ExternalDataSource via connectors"
    }
  ],
  "state_model": {
    "states": [
      { "name": "STOPPED", "description": "Service is not running; no requests or jobs are processed.", "terminal": false },
      { "name": "STARTING", "description": "Configuration is being loaded, dependencies are being connected, health checks run.", "terminal": false },
      { "name": "RUNNING", "description": "Service accepts requests and processes background jobs.", "terminal": false },
      { "name": "DEGRADED", "description": "Service is running but some dependencies are impaired.", "terminal": false },
      { "name": "STOPPING", "description": "Service is completing in-flight work and preparing to shut down.", "terminal": false }
    ],
    "transitions": [
      { "from": "STOPPED", "to": "STARTING", "trigger": "start_command", "responsible_module": "ServiceHost" },
      { "from": "STARTING", "to": "RUNNING", "trigger": "startup_checks_passed", "responsible_module": "ServiceHost" },
      { "from": "RUNNING", "to": "DEGRADED", "trigger": "dependency_health_fails", "responsible_module": "HealthMonitor" },
      { "from": "RUNNING", "to": "STOPPING", "trigger": "stop_command", "responsible_module": "ServiceHost" },
      { "from": "STOPPING", "to": "STOPPED", "trigger": "all_work_completed", "responsible_module": "ServiceHost" }
    ],
    "state_owner": "ServiceHost"
  },
  "modules": [
    {
      "name": "ServiceHost",
      "layer": "infrastructure",
      "responsibilities": [
        "Own the service lifecycle state machine.",
        "Start and stop HTTP servers, worker hosts, and shared resources."
      ],
      "non_responsibilities": ["Business rule implementation.", "Low-level database access."],
      "dependencies": [
        { "target": "ServiceConfig", "type": "config", "reason": "Loads runtime settings." },
        { "target": "HttpApiHost", "type": "component", "reason": "Manages lifecycle of API listener." },
        { "target": "WorkerHost", "type": "component", "reason": "Manages lifecycle of background workers." },
        { "target": "Logger", "type": "utility", "reason": "Observability." }
      ]
    },
    {
      "name": "HttpApiHost",
      "layer": "interface",
      "responsibilities": [
        "Expose HTTP endpoints for synchronous request/response operations.",
        "Route incoming requests to application services."
      ],
      "non_responsibilities": ["Implementing business logic.", "Persisting data directly."],
      "dependencies": [
        { "target": "ApplicationServices", "type": "component", "reason": "Delegates domain logic execution." },
        { "target": "Logger", "type": "utility", "reason": "Request logging." }
      ]
    },
    {
      "name": "WorkerHost",
      "layer": "infrastructure",
      "responsibilities": [
        "Poll queues or schedules and dispatch background jobs.",
        "Control concurrency for job execution."
      ],
      "non_responsibilities": ["Defining specific job semantics."],
      "dependencies": [
        { "target": "ApplicationServices", "type": "component", "reason": "Executes job logic." },
        { "target": "Logger", "type": "utility", "reason": "Job logging." },
        { "target": "MetricsCollector", "type": "utility", "reason": "Throughput tracking." }
      ]
    },
    {
      "name": "ApplicationServices",
      "layer": "domain",
      "responsibilities": [
        "Implement use cases and orchestrate domain operations.",
        "Apply domain rules and invariants."
      ],
      "non_responsibilities": ["Direct HTTP concerns.", "SQL generation."],
      "dependencies": [
        { "target": "Repositories", "type": "component", "reason": "Data access." },
        { "target": "ExternalServiceClients", "type": "component", "reason": "Upstream API calls." }
      ]
    }
  ],
  "classes": [
    {
      "name": "ServiceHost",
      "module": "ServiceHost",
      "kind": "class",
      "responsibilities": [
        "Control the lifecycle of the service process.",
        "Coordinate startup, health checks, and graceful shutdown."
      ],
      "construction": {
        "type": "injection",
        "description": "Orchestrator injected with fully constructed hosts.",
        "args": [
          { "name": "config", "type": "ServiceConfig", "source": "instance" },
          { "name": "http_host", "type": "HttpApiHost", "source": "instance" },
          { "name": "worker_host", "type": "WorkerHost", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "attributes": [
        { "name": "state", "type": "ServiceState", "description": "Current lifecycle state of the service." }
      ],
      "methods": [
        {
          "name": "start",
          "purpose": "Initialize dependencies, start HTTP/worker hosts, and transition to RUNNING.",
          "parameters": [],
          "returns": { "type": "void" },
          "side_effects": ["Changes service state.", "Starts listeners."],
          "errors": ["InitializationError"]
        },
        {
          "name": "stop",
          "purpose": "Trigger graceful shutdown and transition to STOPPED.",
          "parameters": [],
          "returns": { "type": "void" },
          "side_effects": ["Stops accepting requests."],
          "errors": ["ShutdownError"]
        }
      ]
    },

    {
      "name": "HttpApiHost",
      "module": "HttpApiHost",
      "kind": "class",
      "responsibilities": [
        "Bind and listen on configured HTTP ports.",
        "Translate HTTP requests into application-level commands."
      ],
      "construction": {
        "type": "injection",
        "description": "Must receive the service layer to route requests to.",
        "args": [
          { "name": "config", "type": "ServiceConfig", "source": "instance" },
          { "name": "application_services", "type": "ApplicationServices", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "attributes": [
        { "name": "routes", "type": "list<RouteDefinition>", "description": "Registered API routes." }
      ],
      "methods": [
        {
          "name": "start",
          "purpose": "Begin listening for incoming HTTP requests.",
          "parameters": [],
          "returns": { "type": "void" },
          "errors": ["NetworkError"]
        }
      ]
    },

    {
      "name": "WorkerHost",
      "module": "WorkerHost",
      "kind": "class",
      "responsibilities": [
        "Manage background job polling and execution."
      ],
      "construction": {
        "type": "injection",
        "args": [
          { "name": "config", "type": "ServiceConfig", "source": "instance" },
          { "name": "application_services", "type": "ApplicationServices", "source": "instance" },
          { "name": "metrics", "type": "MetricsCollector", "source": "instance" }
        ]
      },
      "methods": [
        { "name": "start", "purpose": "Start job polling.", "parameters": [], "returns": { "type": "void" }, "errors": [] }
      ]
    },

    {
      "name": "ApplicationServices",
      "module": "ApplicationServices",
      "kind": "class",
      "responsibilities": [
        "Execute business logic independent of transport."
      ],
      "construction": {
        "type": "injection",
        "description": "Requires persistence adapter to function.",
        "args": [
          { "name": "repositories", "type": "Repositories", "source": "instance" }
        ]
      },
      "methods": [
        { 
          "name": "execute_use_case",
          "purpose": "Generic handler.",
          "parameters": ["command: Command"],
          "returns": { "type": "Result" },
          "errors": []
        }
      ]
    }
  ],
  "data_structures": [
    {
      "name": "ServiceConfig",
      "kind": "dataclass",
      "python_type_hint": "config.ServiceConfig",
      "serialization_behavior": "object_to_dict",
      "description": "Top-level configuration for the service process.",
      "fields": [
        { "name": "service_name", "type": "string" },
        { "name": "environment", "type": "string" },
        { "name": "http_port", "type": "int" },
        { "name": "worker_concurrency", "type": "int" }
      ]
    },
    {
      "name": "ServiceState",
      "kind": "enum",
      "description": "Lifecycle states for the service.",
      "values": ["STOPPED", "STARTING", "RUNNING", "DEGRADED", "STOPPING"]
    },
    {
      "name": "RouteDefinition",
      "kind": "dataclass",
      "python_type_hint": "http.RouteDefinition",
      "description": "Describes a single HTTP route and its handler.",
      "fields": [
        { "name": "method", "type": "string" },
        { "name": "path", "type": "string" },
        { "name": "handler_name", "type": "string" }
      ]
    }
  ],
  "config": {
    "object_name": "ServiceConfig",
    "fields": [
      {
        "name": "service_name",
        "type": "string",
        "default": "example-service",
        "consumed_by": ["ServiceHost", "Logger"]
      },
      {
        "name": "environment",
        "type": "string",
        "default": "dev",
        "consumed_by": ["ServiceHost", "MetricsCollector"]
      },
      {
        "name": "http_port",
        "type": "int",
        "default": 8080,
        "consumed_by": ["HttpApiHost"]
      },
      {
        "name": "worker_concurrency",
        "type": "int",
        "default": 4,
        "consumed_by": ["WorkerHost"]
      }
    ]
  },
  "randomness": {
    "uses_randomness": true,
    "rng_owner_module": "ApplicationServices",
    "rng_class": "RandomProvider",
    "seeding_policy": "Seeds may be configured explicitly in ServiceConfig or derived from system time."
  },
  "error_handling": {
    "global_policy": "Configuration and initialization errors abort startup.",
    "error_types": ["InitializationError", "ConfigurationError", "NetworkError", "PersistenceError"],
    "recoverable_errors": ["Transient network failures"],
    "fatal_errors": ["Invalid critical configuration"]
  },
  "logging": {
    "levels": ["DEBUG", "INFO", "WARN", "ERROR"],
    "key_events_logged": ["Service start/stop", "Health failures"],
    "metrics": ["request_latency_ms", "request_rate", "job_throughput", "error_rate"]
  },
  "performance": {
    "target_latency_ms_p95": 200,
    "target_throughput_rps": 100,
    "critical_paths": ["Database interactions"]
  },
  "extension_points": [
    {
      "name": "DataStoreAdapter",
      "description": "Pluggable persistence implementation.",
      "registration": "Provided to Repositories during startup."
    },
    {
      "name": "MessageBusAdapter",
      "description": "Pluggable message queue integration.",
      "registration": "Injected into WorkerHost."
    }
  ],
  "testing": {
    "strategy": "Unit tests for domain, integration for HTTP.",
    "test_doubles": ["FakeDataStore", "FakeMessageBus"]
  }
}
