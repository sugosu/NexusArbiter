{
  "metadata": {
    "system_name": "ExampleServicePlatform",
    "domain": "Generic Distributed Application",
    "source_story_type": "implementation_story_v2_architect_enhanced",
    "version": "1.1.1"
  },
  "system_overview": {
    "purpose": "Provide a generic, modular service platform with clear separation between API layer, business logic, background processing, and persistence.",
    "primary_goals": [
      "Deterministic, well-defined behavior for core flows given a configuration.",
      "Loosely coupled modules that can be implemented and tested independently.",
      "A structure that downstream tools can use to generate code, tests, and wiring without guessing."
    ],
    "non_goals": [
      "Defining domain-specific business rules.",
      "Implementing a particular UI framework or frontend.",
      "Handling multi-tenant, multi-region deployment concerns."
    ],
    "wiring_strategy": {
      "description": "Explicit Manual Dependency Injection. The entrypoint constructs the object graph in a deterministic order defined in initialization_graph.",
      "pattern": "manual_dependency_injection",
      "composition_roots": {
        "main": "main.py -> Main"
      },
      "instantiation_order": [
        "ServiceConfig",
        "Logger",
        "MetricsCollector",
        "Repositories (DataStoreAdapter)",
        "ApplicationServices",
        "HttpApiHost",
        "WorkerHost",
        "ServiceHost",
        "Main"
      ]
    }
  },
  "environment": {
    "runtime_model": "single_process_or_multi_process",
    "execution_model": "request_response_plus_background_jobs",
    "entrypoints": {
      "main": "main.py orchestrates construction; Main.run() executes the application."
    },
    "persistence": {
      "strategy": "pluggable_data_store",
      "scope": "domain_entities_and_operational_metadata"
    },
    "ui_mode": "external_client",
    "headless_support": true
  },
  "actors": [
    {
      "name": "ClientApplication",
      "type": "external_system",
      "description": "Any external client (web, mobile, service) that invokes APIs or publishes messages.",
      "interaction_direction": "ClientApplication -> HttpApiHost -> ApplicationServices"
    },
    {
      "name": "ExternalDataSource",
      "type": "external_system",
      "description": "Third-party or upstream system integrated via connectors or adapters.",
      "interaction_direction": "System <-> ExternalDataSource via connectors"
    }
  ],
  "state_model": {
    "states": [
      {
        "name": "STOPPED",
        "description": "Service is not running; no requests or jobs are processed.",
        "terminal": false
      },
      {
        "name": "STARTING",
        "description": "Configuration is being loaded, dependencies are being connected, health checks run.",
        "terminal": false
      },
      {
        "name": "RUNNING",
        "description": "Service accepts requests and processes background jobs.",
        "terminal": false
      },
      {
        "name": "DEGRADED",
        "description": "Service is running but some dependencies are impaired.",
        "terminal": false
      },
      {
        "name": "STOPPING",
        "description": "Service is completing in-flight work and preparing to shut down.",
        "terminal": false
      }
    ],
    "transitions": [
      {
        "from": "STOPPED",
        "to": "STARTING",
        "trigger": "start_command",
        "responsible_module": "ServiceHost"
      },
      {
        "from": "STARTING",
        "to": "RUNNING",
        "trigger": "startup_checks_passed",
        "responsible_module": "ServiceHost"
      },
      {
        "from": "RUNNING",
        "to": "DEGRADED",
        "trigger": "dependency_health_fails",
        "responsible_module": "HealthMonitor"
      },
      {
        "from": "RUNNING",
        "to": "STOPPING",
        "trigger": "stop_command",
        "responsible_module": "ServiceHost"
      },
      {
        "from": "STOPPING",
        "to": "STOPPED",
        "trigger": "all_work_completed",
        "responsible_module": "ServiceHost"
      }
    ],
    "state_owner": "ServiceHost"
  },
  "modules": [
    {
      "name": "Main",
      "layer": "entrypoint",
      "responsibilities": [
        "Application entry point.",
        "Wire dependencies and run the application."
      ],
      "non_responsibilities": [
        "Business rule implementation.",
        "Low-level database access."
      ],
      "dependencies": [
        {
          "target": "ApplicationServices",
          "type": "component",
          "reason": "Executes domain-level operations."
        },
        {
          "target": "Logger",
          "type": "utility",
          "reason": "Observability."
        }
      ]
    },
    {
      "name": "ServiceHost",
      "layer": "infrastructure",
      "responsibilities": [
        "Own the service lifecycle state machine.",
        "Start and stop HTTP servers, worker hosts, and shared resources.",
        "Run startup checks and configure health monitoring."
      ],
      "non_responsibilities": [
        "Business rule implementation.",
        "Low-level database access."
      ],
      "dependencies": [
        {
          "target": "ServiceConfig",
          "type": "config",
          "reason": "Loads runtime settings."
        },
        {
          "target": "HttpApiHost",
          "type": "component",
          "reason": "Manages lifecycle of API listener."
        },
        {
          "target": "WorkerHost",
          "type": "component",
          "reason": "Manages lifecycle of background workers."
        },
        {
          "target": "Logger",
          "type": "utility",
          "reason": "Observability."
        }
      ]
    },
    {
      "name": "HttpApiHost",
      "layer": "interface",
      "responsibilities": [
        "Expose HTTP endpoints for synchronous request/response operations.",
        "Route incoming requests to application services.",
        "Translate transport payloads into normalized application commands."
      ],
      "non_responsibilities": [
        "Implementing business logic.",
        "Persisting data directly."
      ],
      "dependencies": [
        {
          "target": "ApplicationServices",
          "type": "component",
          "reason": "Delegates domain logic execution."
        },
        {
          "target": "Logger",
          "type": "utility",
          "reason": "Request logging."
        }
      ]
    },
    {
      "name": "WorkerHost",
      "layer": "infrastructure",
      "responsibilities": [
        "Poll queues or schedules and dispatch background jobs.",
        "Control concurrency for job execution."
      ],
      "non_responsibilities": [
        "Defining specific job semantics."
      ],
      "dependencies": [
        {
          "target": "ApplicationServices",
          "type": "component",
          "reason": "Executes job logic."
        },
        {
          "target": "Logger",
          "type": "utility",
          "reason": "Job logging."
        },
        {
          "target": "MetricsCollector",
          "type": "utility",
          "reason": "Throughput tracking."
        }
      ]
    },
    {
      "name": "ApplicationServices",
      "layer": "domain",
      "responsibilities": [
        "Implement use cases and orchestrate domain operations.",
        "Apply domain rules and invariants.",
        "Provide an execution surface for normalized Command objects."
      ],
      "non_responsibilities": [
        "Direct HTTP concerns.",
        "SQL generation."
      ],
      "dependencies": [
        {
          "target": "Repositories",
          "type": "component",
          "reason": "Data access."
        },
        {
          "target": "ExternalServiceClients",
          "type": "component",
          "reason": "Upstream API calls."
        }
      ]
    }
  ],
  "classes": [
    {
      "name": "Main",
      "module": "main",
      "kind": "class",
      "responsibilities": [
        "Application entry point.",
        "Wire dependencies and run the application."
      ],
      "construction": {
        "type": "injection",
        "description": "Entry point receives wired dependencies.",
        "args": [
          { "name": "application_services", "type": "ApplicationServices", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "methods": [
        {
          "name": "run",
          "purpose": "Execute core application operations.",
          "parameters": [],
          "returns": { "type": "None" },
          "side_effects": [
            "Invokes application services.",
            "Prints output to stdout."
          ],
          "errors": [
            "PersistenceError",
            "DomainError"
          ]
        }
      ]
    },
    {
      "name": "ServiceHost",
      "module": "service_host",
      "kind": "class",
      "responsibilities": [
        "Control the lifecycle of the service process.",
        "Coordinate startup, health checks, and graceful shutdown."
      ],
      "construction": {
        "type": "injection",
        "description": "Orchestrator injected with fully constructed hosts.",
        "args": [
          {
            "name": "config",
            "type": "ServiceConfig",
            "source": "instance"
          },
          {
            "name": "http_host",
            "type": "HttpApiHost",
            "source": "instance"
          },
          {
            "name": "worker_host",
            "type": "WorkerHost",
            "source": "instance"
          },
          {
            "name": "logger",
            "type": "Logger",
            "source": "instance"
          }
        ]
      },
      "attributes": [
        {
          "name": "state",
          "type": "ServiceState",
          "description": "Current lifecycle state of the service."
        }
      ],
      "methods": [
        {
          "name": "start",
          "purpose": "Initialize dependencies, start HTTP/worker hosts, and transition to RUNNING.",
          "parameters": [],
          "returns": { "type": "void" },
          "side_effects": [
            "Changes service state.",
            "Starts listeners."
          ],
          "errors": [
            "InitializationError"
          ]
        },
        {
          "name": "stop",
          "purpose": "Trigger graceful shutdown and transition to STOPPED.",
          "parameters": [],
          "returns": { "type": "void" },
          "side_effects": [
            "Stops accepting requests."
          ],
          "errors": [
            "ShutdownError"
          ]
        },
        {
          "name": "health",
          "purpose": "Return a snapshot of service health derived from dependencies and current state.",
          "parameters": [],
          "returns": { "type": "HealthSnapshot" },
          "side_effects": [],
          "errors": []
        }
      ]
    },
    {
      "name": "HttpApiHost",
      "module": "http_api_host",
      "kind": "class",
      "responsibilities": [
        "Bind and listen on configured HTTP ports.",
        "Translate HTTP requests into application-level commands."
      ],
      "construction": {
        "type": "injection",
        "description": "Must receive the service layer to route requests to.",
        "args": [
          { "name": "config", "type": "ServiceConfig", "source": "instance" },
          { "name": "application_services", "type": "ApplicationServices", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "attributes": [
        {
          "name": "routes",
          "type": "list<RouteDefinition>",
          "description": "Registered API routes."
        }
      ],
      "methods": [
        {
          "name": "start",
          "purpose": "Begin listening for incoming HTTP requests.",
          "parameters": [],
          "returns": { "type": "void" },
          "errors": [
            "NetworkError"
          ]
        }
      ]
    },
    {
      "name": "WorkerHost",
      "module": "worker_host",
      "kind": "class",
      "responsibilities": [
        "Manage background job polling and execution."
      ],
      "construction": {
        "type": "injection",
        "args": [
          { "name": "config", "type": "ServiceConfig", "source": "instance" },
          { "name": "application_services", "type": "ApplicationServices", "source": "instance" },
          { "name": "metrics", "type": "MetricsCollector", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "methods": [
        {
          "name": "start",
          "purpose": "Start job polling.",
          "parameters": [],
          "returns": { "type": "void" },
          "errors": []
        }
      ]
    },
    {
      "name": "ApplicationServices",
      "module": "application_services",
      "kind": "class",
      "responsibilities": [
        "Execute business logic independent of transport.",
        "Provide deterministic command dispatch for normalized commands."
      ],
      "construction": {
        "type": "injection",
        "description": "Requires persistence adapter to function.",
        "args": [
          { "name": "repositories", "type": "Repositories", "source": "instance" },
          { "name": "logger", "type": "Logger", "source": "instance" }
        ]
      },
      "methods": [
        {
          "name": "execute_use_case",
          "purpose": "Generic handler for normalized commands.",
          "parameters": [
            "command: Command"
          ],
          "returns": { "type": "Result" },
          "errors": [
            "DomainError",
            "PersistenceError"
          ]
        }
      ]
    }
  ],
  "data_structures": [
    {
      "name": "ServiceConfig",
      "kind": "dataclass",
      "python_type_hint": "config.ServiceConfig",
      "serialization_behavior": "object_to_dict",
      "description": "Top-level configuration for the service process.",
      "fields": [
        { "name": "service_name", "type": "string" },
        { "name": "environment", "type": "string" },
        { "name": "http_port", "type": "int" },
        { "name": "worker_concurrency", "type": "int" }
      ]
    },
    {
      "name": "ServiceState",
      "kind": "enum",
      "description": "Lifecycle states for the service.",
      "values": [
        "STOPPED",
        "STARTING",
        "RUNNING",
        "DEGRADED",
        "STOPPING"
      ]
    },
    {
      "name": "RouteDefinition",
      "kind": "dataclass",
      "python_type_hint": "http.RouteDefinition",
      "description": "Describes a single HTTP route and its handler.",
      "fields": [
        { "name": "method", "type": "string" },
        { "name": "path", "type": "string" },
        { "name": "handler_name", "type": "string" }
      ]
    },
    {
      "name": "Command",
      "kind": "dataclass",
      "python_type_hint": "runtime.Command",
      "description": "Normalized command representation across transports.",
      "fields": [
        { "name": "op", "type": "string" },
        { "name": "args", "type": "dict<string, any>" },
        { "name": "meta", "type": "CommandMeta" }
      ]
    },
    {
      "name": "CommandMeta",
      "kind": "dataclass",
      "python_type_hint": "runtime.CommandMeta",
      "description": "Command metadata including source and correlation identifiers.",
      "fields": [
        { "name": "request_id", "type": "string" },
        { "name": "source", "type": "string", "allowed_values": ["http", "worker"] }
      ]
    },
    {
      "name": "Result",
      "kind": "dataclass",
      "python_type_hint": "runtime.Result",
      "description": "Standardized result object for deterministic outputs.",
      "fields": [
        { "name": "ok", "type": "bool" },
        { "name": "value", "type": "any" },
        { "name": "error", "type": "ErrorEnvelope" }
      ]
    },
    {
      "name": "ErrorEnvelope",
      "kind": "dataclass",
      "python_type_hint": "runtime.ErrorEnvelope",
      "description": "Deterministic error shape used across transports.",
      "fields": [
        { "name": "category", "type": "string" },
        { "name": "code", "type": "string" },
        { "name": "message", "type": "string" },
        { "name": "details", "type": "dict<string, any>" }
      ]
    },
    {
      "name": "HealthSnapshot",
      "kind": "dataclass",
      "python_type_hint": "health.HealthSnapshot",
      "description": "Health snapshot returned by ServiceHost.health().",
      "fields": [
        { "name": "state", "type": "ServiceState" },
        { "name": "healthy", "type": "bool" },
        { "name": "components", "type": "list<ComponentHealth>" }
      ]
    },
    {
      "name": "ComponentHealth",
      "kind": "dataclass",
      "python_type_hint": "health.ComponentHealth",
      "description": "Per-component health status.",
      "fields": [
        { "name": "name", "type": "string" },
        { "name": "healthy", "type": "bool" },
        { "name": "message", "type": "string" }
      ]
    }
  ],
  "config": {
    "object_name": "ServiceConfig",
    "fields": [
      {
        "name": "service_name",
        "type": "string",
        "default": "example-service",
        "consumed_by": ["ServiceHost", "Logger"]
      },
      {
        "name": "environment",
        "type": "string",
        "default": "dev",
        "consumed_by": ["ServiceHost", "MetricsCollector", "Logger"]
      },
      {
        "name": "http_port",
        "type": "int",
        "default": 8080,
        "consumed_by": ["HttpApiHost"]
      },
      {
        "name": "worker_concurrency",
        "type": "int",
        "default": 4,
        "consumed_by": ["WorkerHost"]
      }
    ]
  },
  "randomness": {
    "uses_randomness": true,
    "rng_owner_module": "ApplicationServices",
    "rng_class": "RandomProvider",
    "seeding_policy": "Seeds may be configured explicitly in ServiceConfig or derived from system time."
  },
  "error_handling": {
    "global_policy": "Configuration and initialization errors abort startup. Runtime errors return deterministic error envelopes.",
    "error_types": [
      "InitializationError",
      "ConfigurationError",
      "NetworkError",
      "PersistenceError",
      "DomainError"
    ],
    "recoverable_errors": [
      "Transient network failures",
      "Transient external dependency failures"
    ],
    "fatal_errors": [
      "Invalid critical configuration"
    ]
  },
  "logging": {
    "levels": ["DEBUG", "INFO", "WARN", "ERROR"],
    "key_events_logged": [
      "Service start/stop",
      "Health failures",
      "Application operation start/end"
    ],
    "metrics": [
      "request_latency_ms",
      "request_rate",
      "job_throughput",
      "error_rate"
    ]
  },
  "performance": {
    "target_latency_ms_p95": 200,
    "target_throughput_rps": 100,
    "critical_paths": [
      "Database interactions"
    ]
  },
  "extension_points": [
    {
      "name": "DataStoreAdapter",
      "description": "Pluggable persistence implementation.",
      "registration": "Provided to Repositories during startup."
    },
    {
      "name": "MessageBusAdapter",
      "description": "Pluggable message queue integration.",
      "registration": "Injected into WorkerHost."
    }
  ],
  "testing": {
    "strategy": "Unit tests for domain; integration tests for HTTP; smoke tests for main entry point.",
    "test_doubles": [
      "FakeDataStore",
      "FakeMessageBus"
    ]
  },
  "persistence_contract": {
    "identity_policy": {
      "owner": "ApplicationServices",
      "id_type": "string",
      "id_format": "uuid4",
      "id_immutability": true,
      "stability_rules": [
        "IDs are assigned once at entity creation and never change.",
        "Updates and re-saves preserve existing IDs."
      ]
    },
    "schemas": {
      "operational_metadata.json": {
        "root": { "type": "object" },
        "required": ["schema_version", "last_migration_id"],
        "properties": {
          "schema_version": { "type": "string" },
          "last_migration_id": { "type": "string" }
        }
      }
    },
    "atomic_mutations": {
      "policy": "write_temp_then_rename",
      "temp_suffix": ".tmp",
      "fsync_policy": "best_effort"
    },
    "bootstrap_safe_reads": {
      "missing_file_behavior": "treat_as_empty_or_default",
      "corrupt_file_behavior": "fail_with_persistence_error"
    }
  },
  "initialization_graph": {
    "composition_roots": ["main"],
    "nodes": [
      {
        "id": "service_config",
        "module": "config",
        "class": "ServiceConfig",
        "lifecycle": "singleton",
        "construct": { "type": "constructor", "params": [] }
      },
      {
        "id": "logger",
        "module": "logger",
        "class": "Logger",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "service_name", "source_type": "config_field", "source": "service_name" },
            { "name": "environment", "source_type": "config_field", "source": "environment" }
          ]
        }
      },
      {
        "id": "metrics_collector",
        "module": "metrics",
        "class": "MetricsCollector",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "environment", "source_type": "config_field", "source": "environment" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      },
      {
        "id": "repositories",
        "module": "repositories",
        "class": "Repositories",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": []
        }
      },
      {
        "id": "application_services",
        "module": "application_services",
        "class": "ApplicationServices",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "repositories", "source_type": "component", "source": "repositories" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      },
      {
        "id": "http_api_host",
        "module": "http_api_host",
        "class": "HttpApiHost",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "config", "source_type": "component", "source": "service_config" },
            { "name": "application_services", "source_type": "component", "source": "application_services" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      },
      {
        "id": "worker_host",
        "module": "worker_host",
        "class": "WorkerHost",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "config", "source_type": "component", "source": "service_config" },
            { "name": "application_services", "source_type": "component", "source": "application_services" },
            { "name": "metrics", "source_type": "component", "source": "metrics_collector" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      },
      {
        "id": "service_host",
        "module": "service_host",
        "class": "ServiceHost",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "config", "source_type": "component", "source": "service_config" },
            { "name": "http_host", "source_type": "component", "source": "http_api_host" },
            { "name": "worker_host", "source_type": "component", "source": "worker_host" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      },
      {
        "id": "main",
        "module": "main",
        "class": "Main",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "application_services", "source_type": "component", "source": "application_services" },
            { "name": "logger", "source_type": "component", "source": "logger" }
          ]
        }
      }
    ]
  },
  "runtime": {
    "entrypoints": {
      "main": {
        "file": "main.py",
        "call": "Main.run"
      }
    }
  }
}