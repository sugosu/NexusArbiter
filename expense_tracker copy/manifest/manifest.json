{
  "metadata": {
    "system_name": "ExpenseTracker",
    "domain": "Personal Finance",
    "source_story_type": "design_story_expense_tracker",
    "version": "0.1.0"
  },

  "system_overview": {
    "purpose": "Persist and manage a single-file JSON expense ledger with deterministic, auditable, and atomic persistence semantics.",
    "primary_goals": [
      "Persist all domain data in a single, human-readable JSON file at a configurable path.",
      "Ensure deterministic, stable, pretty-printed JSON output with stable field ordering.",
      "Encapsulate filesystem operations in a repository that performs atomic writes to avoid corruption.",
      "Provide read-modify-write transactions so business logic never performs direct filesystem IO."
    ],
    "non_goals": [
      "No remote or distributed storage; local filesystem only.",
      "No concurrent multi-process writers; single-process ownership assumed.",
      "No UI or rendering responsibilities; adapters provide CLI/API as needed."
    ],
    "wiring_strategy": {
      "description": "Explicit Manual Dependency Injection. AppController is the composition root and orchestrates construction in the order defined in the initialization_graph.",
      "pattern": "manual_dependency_injection",
      "composition_root": "app_controller",
      "instantiation_order": [
        "Config",
        "JsonSerializer",
        "AtomicFileWriter",
        "ExpenseRepository",
        "ExpenseValidator",
        "ExpenseService",
        "AppController"
      ]
    }
  },

  "runtime": {
    "entrypoint": {
      "module": "app_controller",
      "class": "AppController",
      "init_params": {
        "config": { "component": "Config" },
        "serializer": { "component": "JsonSerializer" },
        "writer": { "component": "AtomicFileWriter" },
        "repository": { "component": "ExpenseRepository" },
        "service": { "component": "ExpenseService" }
      },
      "run_method": "start",
      "run_args": {}
    }
  },

  "modules": [
    {
      "name": "Config",
      "layer": "infrastructure",
      "responsibilities": [ "Holds runtime tunables and defaults used by all modules." ],
      "components": [
        {
          "name": "Config",
          "type": "class",
          "module": "config",
          "file": "src/config.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "store_path", "type": "string", "default": "data/expenses.json" },
              { "name": "temp_suffix", "type": "string", "default": ".tmp" },
              { "name": "allowed_categories", "type": "list<string>", "default": ["food","transport","utilities","entertainment","health","other"] },
              { "name": "default_currency", "type": "string", "default": "PLN" },
              { "name": "description_max_length", "type": "int", "default": 1024 },
              { "name": "json_indent", "type": "int", "default": 2 },
              { "name": "serializer_field_order", "type": "map<string,list<string>>", "default": {"store": ["expenses","settings"], "expense": ["id","date","amount","category","description"], "settings": ["currency"]} }
            ]
          }
        }
      ]
    },

    {
      "name": "Serializer",
      "layer": "infrastructure",
      "responsibilities": [ "Deterministic serialization and deserialization of the ExpenseStore with stable field ordering and pretty-printing." ],
      "components": [
        {
          "name": "JsonSerializer",
          "type": "class",
          "module": "json_serializer",
          "file": "src/json_serializer.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "field_order", "type": "map<string,list<string>>", "source": "Config", "source_field": "serializer_field_order" },
              { "name": "indent", "type": "int", "source": "Config", "source_field": "json_indent" }
            ]
          }
        }
      ]
    },

    {
      "name": "AtomicFileWriter",
      "layer": "infrastructure",
      "responsibilities": [ "Perform atomic write operations: write-to-temp, fsync, and atomic rename." ],
      "components": [
        {
          "name": "AtomicFileWriter",
          "type": "class",
          "module": "atomic_file_writer",
          "file": "src/atomic_file_writer.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "fsync_after_write", "type": "bool", "default": true },
              { "name": "temp_suffix", "type": "string", "source": "Config", "source_field": "temp_suffix" }
            ]
          }
        }
      ]
    },

    {
      "name": "Models",
      "layer": "domain",
      "responsibilities": [ "Define domain data structures: Expense, Settings, ExpenseStore, and lifecycle state enum." ],
      "components": [
        {
          "name": "Expense",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "id", "type": "int" },
              { "name": "date", "type": "string" },
              { "name": "amount", "type": "decimal" },
              { "name": "category", "type": "string" },
              { "name": "description", "type": "string|null" }
            ]
          }
        },
        {
          "name": "Settings",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "currency", "type": "string" }
            ]
          }
        },
        {
          "name": "ExpenseStore",
          "type": "dataclass",
          "module": "models",
          "file": "src/models.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "expenses", "type": "list<Expense>", "default": [] },
              { "name": "settings", "type": "Settings" }
            ]
          }
        },
        {
          "name": "AppState",
          "type": "enum",
          "module": "models",
          "file": "src/models.py",
          "construction": {
            "type": "composition",
            "args": [
              { "name": "values", "type": "list<string>", "default": ["INIT","READY","ERROR","SHUTDOWN"] }
            ]
          }
        }
      ]
    },

    {
      "name": "Repository",
      "layer": "infrastructure",
      "responsibilities": [ "Only component allowed to perform filesystem IO: load, validate structure, repair default store, and atomic save of the single JSON file." ],
      "components": [
        {
          "name": "ExpenseRepository",
          "type": "class",
          "module": "expense_repository",
          "file": "src/expense_repository.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "path", "type": "string", "source": "Config", "source_field": "store_path" },
              { "name": "serializer", "type": "JsonSerializer", "source": "instance" },
              { "name": "writer", "type": "AtomicFileWriter", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Validation",
      "layer": "domain",
      "responsibilities": [ "Validate expenses and settings according to domain invariants." ],
      "components": [
        {
          "name": "ExpenseValidator",
          "type": "class",
          "module": "expense_validator",
          "file": "src/expense_validator.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "allowed_categories", "type": "list<string>", "source": "Config", "source_field": "allowed_categories" },
              { "name": "description_max_length", "type": "int", "source": "Config", "source_field": "description_max_length" }
            ]
          }
        }
      ]
    },

    {
      "name": "Service",
      "layer": "domain",
      "responsibilities": [ "Business operations: add, update, delete, list expenses, and manage settings while delegating persistence to the repository." ],
      "components": [
        {
          "name": "ExpenseService",
          "type": "class",
          "module": "expense_service",
          "file": "src/expense_service.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "repository", "type": "ExpenseRepository", "source": "instance" },
              { "name": "validator", "type": "ExpenseValidator", "source": "instance" }
            ]
          }
        }
      ]
    },

    {
      "name": "Controller",
      "layer": "infrastructure",
      "responsibilities": [ "Top-level orchestration, initialize system, validate/repair store on startup, manage application state machine, and expose operations to adapters." ],
      "components": [
        {
          "name": "AppController",
          "type": "class",
          "module": "app_controller",
          "file": "src/app_controller.py",
          "construction": {
            "type": "injection",
            "args": [
              { "name": "config", "type": "Config", "source": "instance" },
              { "name": "serializer", "type": "JsonSerializer", "source": "instance" },
              { "name": "writer", "type": "AtomicFileWriter", "source": "instance" },
              { "name": "repository", "type": "ExpenseRepository", "source": "instance" },
              { "name": "service", "type": "ExpenseService", "source": "instance" }
            ]
          }
        }
      ]
    }
  ],

  "initialization_graph": {
    "composition_root": "app_controller",
    "nodes": [
      {
        "id": "config",
        "module": "config",
        "class": "Config",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": []
        }
      },
      {
        "id": "json_serializer",
        "module": "json_serializer",
        "class": "JsonSerializer",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "field_order", "source_type": "config_field", "source": "serializer_field_order" },
            { "name": "indent", "source_type": "config_field", "source": "json_indent" }
          ]
        }
      },
      {
        "id": "atomic_writer",
        "module": "atomic_file_writer",
        "class": "AtomicFileWriter",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "fsync_after_write", "source_type": "constant", "source": true },
            { "name": "temp_suffix", "source_type": "config_field", "source": "temp_suffix" }
          ]
        }
      },
      {
        "id": "expense_repository",
        "module": "expense_repository",
        "class": "ExpenseRepository",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "path", "source_type": "config_field", "source": "store_path" },
            { "name": "serializer", "source_type": "component", "source": "json_serializer" },
            { "name": "writer", "source_type": "component", "source": "atomic_writer" }
          ]
        }
      },
      {
        "id": "expense_validator",
        "module": "expense_validator",
        "class": "ExpenseValidator",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "allowed_categories", "source_type": "config_field", "source": "allowed_categories" },
            { "name": "description_max_length", "source_type": "config_field", "source": "description_max_length" }
          ]
        }
      },
      {
        "id": "expense_service",
        "module": "expense_service",
        "class": "ExpenseService",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "repository", "source_type": "component", "source": "expense_repository" },
            { "name": "validator", "source_type": "component", "source": "expense_validator" }
          ]
        }
      },
      {
        "id": "app_controller",
        "module": "app_controller",
        "class": "AppController",
        "lifecycle": "singleton",
        "construct": {
          "type": "constructor",
          "params": [
            { "name": "config", "source_type": "component", "source": "config" },
            { "name": "serializer", "source_type": "component", "source": "json_serializer" },
            { "name": "writer", "source_type": "component", "source": "atomic_writer" },
            { "name": "repository", "source_type": "component", "source": "expense_repository" },
            { "name": "service", "source_type": "component", "source": "expense_service" }
          ]
        }
      }
    ]
  },

  "data_structures": [
    {
      "name": "Config",
      "kind": "dataclass",
      "python_type_hint": "config.Config",
      "fields": [
        { "name": "store_path", "type": "string" },
        { "name": "temp_suffix", "type": "string" },
        { "name": "allowed_categories", "type": "list<string>" },
        { "name": "default_currency", "type": "string" },
        { "name": "description_max_length", "type": "int" },
        { "name": "json_indent", "type": "int" },
        { "name": "serializer_field_order", "type": "map<string,list<string>>" }
      ]
    },
    {
      "name": "Expense",
      "kind": "dataclass",
      "python_type_hint": "models.Expense",
      "fields": [
        { "name": "id", "type": "int" },
        { "name": "date", "type": "string" },
        { "name": "amount", "type": "decimal" },
        { "name": "category", "type": "string" },
        { "name": "description", "type": "string|null" }
      ]
    },
    {
      "name": "Settings",
      "kind": "dataclass",
      "python_type_hint": "models.Settings",
      "fields": [
        { "name": "currency", "type": "string" }
      ]
    },
    {
      "name": "ExpenseStore",
      "kind": "dataclass",
      "python_type_hint": "models.ExpenseStore",
      "fields": [
        { "name": "expenses", "type": "list<Expense>" },
        { "name": "settings", "type": "Settings" }
      ]
    },
    {
      "name": "AppState",
      "kind": "enum",
      "python_type_hint": "models.AppState",
      "values": ["INIT","READY","ERROR","SHUTDOWN"]
    }
  ],

  "config": {
    "object_name": "Config",
    "fields": [
      { "name": "store_path", "type": "string", "default": "data/expenses.json", "consumed_by": ["ExpenseRepository","AppController"] },
      { "name": "temp_suffix", "type": "string", "default": ".tmp", "consumed_by": ["AtomicFileWriter"] },
      { "name": "allowed_categories", "type": "list<string>", "default": ["food","transport","utilities","entertainment","health","other"], "consumed_by": ["ExpenseValidator"] },
      { "name": "default_currency", "type": "string", "default": "PLN", "consumed_by": ["ExpenseRepository"] },
      { "name": "description_max_length", "type": "int", "default": 1024, "consumed_by": ["ExpenseValidator"] },
      { "name": "json_indent", "type": "int", "default": 2, "consumed_by": ["JsonSerializer"] },
      { "name": "serializer_field_order", "type": "map<string,list<string>>", "default": {"store": ["expenses","settings"], "expense": ["id","date","amount","category","description"], "settings": ["currency"]}, "consumed_by": ["JsonSerializer"] }
    ]
  }
}
